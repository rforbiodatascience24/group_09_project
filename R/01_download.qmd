---
title: "01_download"
author: 
  - "Andreis Marco(s243116)" 
  - "Asiya Mohamad Yusuf Muse (s243930)"
  - "Magnus Harthimmer (s233426)"  
  - "Anita Skovbjerg Hjort-Gregersen (s201190)"
  - "Rebecca Hjermind Millum (s215024)"
  
format: html
editor: visual
---

```{r}
library('tidyverse')
library('httr')
library('jsonlite')
```

Setup the \_raw folder by checking if it already exists and eventually creating if it does not.

```{r}
data_file <- "abundance.csv"
target_dir <- "../_raw/"

# Create the _raw folder if it does not exist 
if (!file.exists(target_dir)) {
  dir.create(target_dir, recursive = TRUE)
}
```

Check if the dataset file is already present, if it is not we collect it programmatically from kaggle.

```{r}
# check if the file is already present 
already_present <- file.exists(str_c(target_dir, data_file))

if (already_present) 
  {
  message(str_c("The dataset file is already present. Check ", target_dir))
  } else {
  # Define the Kaggle dataset path and download location
  dataset_slug <- "antaresnyc/human-metagenomics"
  output_file <- "../_raw/human_metagenomics.zip"
  
  # Download the file
  response <- GET(
    url = str_c("https://www.kaggle.com/api/v1/datasets/download/", dataset_slug),
    write_disk(output_file, overwrite = TRUE)
  )
  unzip(output_file, exdir = target_dir)
  
  # Get list of all the files in _raw
  extracted_files <- list.files(target_dir, recursive = TRUE)
  
  # Select and delete the unwanted files (kaggle does not allow download of single files)
  files_to_delete <- setdiff(extracted_files, data_file)
  
  walk(files_to_delete,
       ~ {file_path <- file.path(target_dir,
                                 .x)
       if (file.exists(file_path)) 
         {
         file.remove(file_path)
         }})
  }
```
